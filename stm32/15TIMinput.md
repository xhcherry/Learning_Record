# TIM输入捕获

## 输入捕获

### 输入捕获简介

输入捕获，即Input Capture，英文缩写为IC。输入捕获模式下，当通道输入引脚出现指定电平跳变瞬间（可以定义为上升沿、下降沿），当前CNT的值将被锁存到CCR中（检测电平跳变，然后执行动作（作用和外部中断差不多，只不过外部中断执行的动作是向CPU申请中断，输入捕获执行的是控制后续电路）），可用于测量PWM波形的频率、占空比、脉冲间隔、电平持续时间等参数。在这里，脉冲间隔和频率差不多、电平持续时间和占空比也是互相对应的关系。

每个高级定时器和通用定时器都拥有4各输入捕获通道，且二者没有区别。基本定时器没有输入捕获的功能。

 输入捕获模块可以配置为PWMI（PWM输入）模式和主从触发模式。PWMI模式是PWM的输入模式，专门用来同时测量PWM波形的频率和占空比的。主从触发模式可以实现对频率或占空比的硬件的全自动测量。把这两个功能结合起来，测量频率和占空比就是硬件全自动执行，软件不需进行任何干预，也不需进中断，需要测量的时候，直接读取CCR寄存器就行了，使用非常方便且极大地减轻了软件的压力。

如下图，左边为输入捕获电路，4个输入捕获和输出比较通道，共用4个CCR寄存器，另外它们的CH1到4的4个通道引脚也是共用的，所以对于同一个定时器，输入捕获和输出比较只能使用其中一个，不能同时使用。

输入捕获对比输出比较：

输出比较，引脚是输出端口，根据CNT和CCR的大小关系来执行输出动作

输入捕获，引脚是输入端口，接收到输入信号执行CNT锁存到CCR的动作

### 输入捕获的各部分电路
从左向右依次进行电路分析：

![](https://pic.xhcheats.cn/assets/2024/01/16/015053.png)

最左边是四个通道的引脚，参考引脚定义表，就指导引脚是复用在哪个位置

然后引脚进来，有一个三输入的异或门，这个异或门的输入接在了通道1、2、3端口，异或门的执行逻辑是，当三个引脚的任何一个有电平翻转时，输出引脚就产生一次电平翻转，3个引脚电平都相同为0，3个引脚中有高有低为1。

然后输出通过数据选择器，到达输入捕获通道1，数据选择器如果选择上面一个，那输入捕获通道1的输入就是三个引脚的异或值；若选择下面一个，异或门就没有用。设计异或门，其实还是为了三相无刷电机服务的，无刷电机有三个霍尔传感器检测转子的位置，可以根据转子的位置来进行换相。

输入信号来到了输入滤波器和边沿检测器（极性选择）。输入滤波器可以对信号进行滤波，避免一些高频的毛刺信号误触发；边沿检测器就是和外部中断一样，可以选择高电平触发或者低电平触发，当出现指定的电平时，边沿检测电路就会触发后续电路执行动作。设计了两套滤波和边沿检测电路，第一套电路经过滤波和极性选择得到TI1FP1，输入给通道1的后续电路。第二套电路，经过另一个滤波和极性选择，得到TI1FP2，输入给通道2的后续电路，同理，下面TI2信号进来，也经过两套滤波和极性选择得到TI2FP1输入通道1和TI2FP2输入通道2。可以进行交叉连接，例如CH1引脚输入给通道2，CH2引脚输入给通道1，进行交叉连接的目的是两个：1.一个通道灵活切换两个引脚，可以灵活切换后续捕获电路的输入，2.两个通道同时捕获一个引脚，可以把一个引脚的输入，同时映射到两个捕获单元，这也是PWMI模式的经典结构，实现两个通道（IC）对一个引脚（CH）进行捕获，就可以同时测量频率和占空比。可以选择各自独立连接，也可以选择进行交叉连接。另外还有一个TRC信号，也可选择作为捕获部分的输入，TRC信号来源于最上面，设计也是为了无刷电机的驱动。

然后来到了预分频器。每个通道各有一个预分频器，可以选择对前面的信号进行分频，分频之后的触发信号，就可以触发电路进行工作了，每来一个触发信号，CNT的值就会向CCR转运一次，转运的同时会发生一个捕获事件，这个事件会在状态寄存器置标志位，同时也可以产生中断，如果需要在捕获的瞬间，处理一些事情的话，就可以开启这个捕获中断，比如可以配置上升沿触发捕获，每来一个上升沿，CNT转运到CCR一次，又因为CNT计数器是由内部的标准时钟驱动的，所以CNT的数值可以用来记录两个上升沿之间的时间间隔（周期）再取倒数就是测周法测量的频率了，在一次捕获后将CNT清零（可以用主从触发模式来自动完成CNT清零）

输入捕获通道1的详细框图如下所示：（如下是上面框图的一个细化结构，基本功能都是一样的）

![](https://pic.xhcheats.cn/assets/2024/01/16/015150.png)

如上图，电路细节内容如下：

引脚进来，先经过一个滤波器，滤波器的输入是TI1就是CH1的引脚，输出的TI1F就是滤波后的信号

FDTS是滤波器的采样时钟来源

CCMR1寄存器里的ICF位可以控制滤波器的参数

滤波器的工作原理就是：以采样频率对输入信号进行采样，当连续N个值都为高电平，输出才为高电平，当连续N个值都为低电平，输出才为低电平，如果信号出现高频抖动，导致连续采样N个值不全都一样，那输出就不会变化，这样就可以达到滤波的效果。采样频率越低，采样个数N越大，滤波效果就越好。在实际应用中，如果波形噪声比较大，就可以把IC1F位参数设置大一点来过滤噪声。

滤波之后的信号通过边沿检测器。捕获上升沿或者下降沿

CCER寄存器里的CC1P位可以进行极性选择

最终得到TI1FP1触发信号

通过数据选择器，进入通道1后续的捕获电路。

当然还有一套一样的电路得到TI1FP2触发信号，连通到通道2的后续电路，上图并没有画出来，同样，通道2有TI2FP1连通到通道1的后续，通道2也有TI2FP2连通到通道2的后续，总共有四种连接方式，然后经过数据选择器，进入后续捕获部分电路

CCMR寄存器的CC1S位可以对数据选择器进行选择

之后，CCMR寄存器的ICPS位可以配置分频器，可以选择不分频、2分频、4分频、8分频

CCMR寄存器的CC1E位，控制输出使能或失能。如果使能了输出，输入端产生指定边沿信号，经过层层电路，就可以最后将CNT的值转运到CCR里来，每捕获一次CNT的值，都要把CNT清0一下，以便于下一次的捕获，从模式控制器就可以在捕获之后自动完成CNT的清零工作

TI1FP1信号和TI1F_ED边沿信号，都可以通向从模式控制器，比如TI1FP1信号的上升沿触发捕获，还可以同时触发从模式，这个从模式里就有电路，可以自动完成CNT的清零。从模式就是完成自动化操作的利器

### 输入捕获的主模式、从模式、触发源选择（简称：主从触发模式）

![](https://pic.xhcheats.cn/assets/2024/01/16/015239.png)

CCR对CNT进行捕获之后，需要对CNT进行一次清0操作，这样每次捕获得到的值才是测周法，两个上升沿（下降沿）之间的时间间隔。这个清0操作，就需要用到主从触发模式来自动完成。由输入捕获通道1的详细框图可得：经过滤波和极性选择的TI1FP1信号和经过滤波的边沿信号TI1F_ED都可以通向从模式控制器，之后便可以通过硬件电路自动完成CNT的清0操作。

  主从触发模式，即主模式、从模式和触发源选择三个功能的简称。主模式可以将定时器内部的信号映射到TRGO引脚，用于触发其他外设的操作；从模式可以接收其他外设或自身外设的一些信号，用于触发自己的一些操作（定时器的运行）；触发源选择，即选择从模式的触发信号源功能，也可以认为它是从模式的一部分。

  在从模式下，可以通过触发源选择功能选择一个信号产生TRGI信号，之后去触发从模式，从模式可以在上面列表中选择一项操作来自动执行。关于主从模式的详细说明可以参见手册：

![](https://pic.xhcheats.cn/assets/2024/01/16/015342.png)

![](https://pic.xhcheats.cn/assets/2024/01/16/015410.png)

![](https://pic.xhcheats.cn/assets/2024/01/16/015414.png)

### 输入捕获和PWMI基本结构

输出捕获模式测频率的基本结构图

![](https://pic.xhcheats.cn/assets/2024/01/16/015504.png)

上图清晰地展示了输入捕获模式测量频率的过程，同时也是编程的逻辑基础。在这里我们只使用了一个通道，所以它只能测量频率。

  首先，配置时基单元，启动寄存器，则CNT就会在预分频之后的时钟驱动下不断自增。测周法用CNT来计数，间接实现计时的功能。经过预分频后的时钟频率，就是测周法的标准频率fc。之后，GPIO输入一个待测的方波信号，经过经过滤波器和边沿检测选择TI1FP1为上升沿触发，之后数据选择器选择直连通道，分频器选择不分频。当TI1FP1出现上升沿之后，CNT的值就会被CCR1转运捕获；同时触发源选择模块选择TI1FP1为触发信号，从模式选择复位操作，触发CNT清零（先后顺序是：先转运CNT的值到CCR，再触发从模式给CNT清零。或者是非阻塞的同时转移：CNT的值转移到CCR，同时0转移到CNT里面去，总之是先捕获，再清零）。当电路不断工作时，CCR1中的值始终是最新一个周期的计数值，即测周法的计次数 N。所以，当我们想读取信号的频率时，只需要读取CCR1得到N，再计算fc/N就得到频率了。当不需要读取时，整个电路全自动的测量，不需要占用任何软件资源。

这里需要注意以下两点：

CNT的计数值是有上限的。由于ARR最大为65535，故CNT最大也只能计65535个数。如果信号频率太低，CNT的计数值可能会溢出。

从模式的触发源选择中有TI1FP1和TI2FP2，但是没有TI3和TI4的信号。所以如果要使用从模式自动清零CNT，就必须使用通道1或通道2作为输入。对于通道3和通道4，就只能开启捕获中断，在中断中手动清0了（程序会处于频繁中断的状态，比较占用软件资源）。

PWMI基本结构

![](https://pic.xhcheats.cn/assets/2024/01/16/015540.png)

PWMI模式使用两个通道同时捕获一个引脚，可以同时测量周期和占空比，相比前面输入捕获，下面多了一个TI1FP2的通道。

首先TI1FP1配置上升沿触发，触发捕获和清零CNT，正常的捕获周期，再来一个TI1FP2，配置为下降沿触发，通过交叉通道去触发通道2的捕获单元（最开始上升沿CCR1捕获同时清零CNT，之后CNT一直加，然后在下降沿时刻触发CCR2捕获，这时CCR2的值就是CNT从上升沿到下降沿的计数值也就是高电平期间的计数值，CCR2捕获并不触发CNT清零，所以CNT继续加，直到下一次上升沿，CCR1捕获周期并CNT清零，这样执行之后CCR1就是一整个周期的计数值，CCR2就是高电平期间的计数值，用CCR2/CCR1就是占空比，以上就是PWMI模式使用两个通道来捕获频率和占空比的思路。另外也可以两个通道同时捕获第一个引脚的输入）

## 频率的测量方法

![](https://pic.xhcheats.cn/assets/2024/01/16/015603.png)

如上图是频率逐渐降低的方波波形，越往左频率越高，越往右频率越低，这里信号都是只有高低电平的数字信号，对于STM32测频率而言，它也是只能测量数字信号的。如果需要测量一个正弦波则需要搭建一个信号预处理电路，最简单的就是用运放搭建一个比较器，把正弦波转换为数字信号再输入给STM32就行了；如果你测量的信号电压非常高，那还要考虑隔离的问题，比如使用隔离放大器、电压互感器等元件，隔离高压端和低压端，保证电路的安全。总之，经过处理最终输入给STM32的信号是如上图的高低电平信号，高电平3.3v，低电平0v。

为了测量频率，有两种方法可以选择：测频法、测周法

测频法：定时器中断，并记录捕获次数；测周法：捕获中断，并记录定时器次数。

测频法的测试方法（直接按频率定义来进行测量的方法）是：在闸门时间T内，对上升沿（也可以是下降沿）计次，得到N，则待测信号频率𝑓𝑥 为: 𝑓𝑥 = 𝑁 / 𝑇

例如，可以定义闸门时间闸门时间T=1s （砸门时间不是必须为1s），则在一秒中得到的上升沿的个数（每来一个上升沿就是完整的一个周期的信号个数）就是频率

频率的定义就是，1s内出现了多少个重复的周期，那频率就是多少Hz

测周法的测试方法是：两个上升沿内，以标准频率fc计次，fc=72M/（psc+1），得到N(就是读取CCR的值)，则测量频率𝑓𝑥为：𝑓𝑥 = 𝑓𝑐 / 𝑁 

测周法的基本思想是：周期的倒数就是频率。如果我们能用定时器测量出一个周期的时间（相邻上升沿或相邻下降沿的间隔时间）取倒数即得到测量频率。

捕获信号的两个上升沿，然后测量一下两个上升沿之间持续的时间，但是实际上，并没有一个精度无穷大的秒表来测量时间，测量时间的方法，实际上也是定时器计次，我们使用一个已知的标准频率fc的计次时钟来驱动计数器，从一个上升沿开始计数器从0开始一直计到下一个上升沿停止，计一个数的时间是1/fc，计N个数时间就是N/fc也就是周期，再取倒数就得到了频率fx

输入捕获模块采用测周法进行测量。

测频法和测周法的误差分析:当待测信号频率小于中界频率时，测周法误差更小，选择测周法更合适；当待测信号频率大于中界频率时，测频法误差更小，选择测频法更合适。

用STM32来实现测频法和测周法:

测频法，之前学过的外设可以实现，对射式红外传感器计次、定时器外部时钟，这些代码稍加改进就是测频法，比如 对射式红外传感器计次，每来一个上升沿计次+1，再用一个定时器，定一个1s的定时中断，在中断里，每隔1s取一下计次值，同时清0，为下一次做准备，这样每次读取的计次值就直接是频率；对应定时器外部时钟的代码，也是如此，每隔1s取一下计次，就能实现测频法测量频率的功能了。

本节输入捕获测频率，使用的方法是测周法。就是测量两个上升沿之间的时间，来进行频率测量。

## 手册

手册中，脉冲宽度测量就是占空比，周期测量就是频率

主要理解，从模式配合输入捕获完成硬件自动化

14.3.5；14.3.6；14.3.15